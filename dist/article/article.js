function get(t){if(t=new RegExp("[?&]"+encodeURIComponent(t)+"=([^&]*)").exec(location.search))return decodeURIComponent(t[1])}let i18nTexts={};try{const t=get("i18n");t&&""!==t.trim()&&(i18nTexts=JSON.parse(t))}catch(t){console.error("Failed to parse i18n texts:",t),i18nTexts={}}function i18n(t,e){try{const n=t.split(".");let r=i18nTexts;for(const a of n){if(!r||"object"!=typeof r||!(a in r))return String(e||t);r=r[a]}return String(r||e||t)}catch(n){return console.error("Error in i18n function:",n,"key:",t),String(e||t)}}let dir=get("d");function extractVideoId(t){const e=t.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);return e?e[1]:null}"1"===dir?document.body.classList.add("rtl"):"2"===dir&&(document.body.classList.add("vertical"),document.body.addEventListener("wheel",(t=>{document.scrollingElement.scrollLeft-=t.deltaY})));let youtubePlayerCounter=0;const youtubePlayers=new Map,playerInstances=new Map,transcriptData=new Map,transcriptIntervals=new Map,userScrolling=new Map,scrollResumeTimers=new Map,transcriptSelectedLanguages=new Map,transcriptMenuOpen=new Map,transcriptTranslations=new Map,transcriptTranslating=new Map,lastScrollTarget=new Map,transcriptSummaries=new Map,transcriptQuotes=new Map,transcriptChatMessages=new Map;function convertYouTubeLinks(t){return t&&"string"==typeof t?t.replace(/<a\s+[^>]*href\s*=\s*["']([^"']*(?:youtube\.com|youtu\.be)[^"']*)["'][^>]*>.*?<\/a>/gi,(t=>{const e=t.match(/href\s*=\s*["']([^"']*)["']/i);if(!e||!e[1])return t;const n=extractVideoId(e[1]);if(n){const t="youtube-player-"+youtubePlayerCounter++,e="youtube-transcript-"+(youtubePlayerCounter-1);return youtubePlayers.set(t,n),`<div id="${t}" style="position: relative; width: 100%; max-width: 700px; aspect-ratio: 16 / 9; overflow: hidden; background-color: #000; margin: 16px auto; display: block;">\n                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></div>\n            </div>\n            <div id="${e}" class="youtube-transcript-container"></div>`}return t})):t||""}function startLoadingTranscripts(){youtubePlayers.forEach(((t,e)=>{const n=`youtube-transcript-${e.replace("youtube-player-","")}`;document.getElementById(n)&&renderTranscript(n,t).catch((t=>{console.error("Error rendering transcript:",t)}))}))}function initializeYouTubePlayers(){if(0!==youtubePlayers.size)if(window.YT&&window.YT.Player)createYouTubePlayers();else{if(!document.querySelector('script[src="https://www.youtube.com/iframe_api"]')){const t=document.createElement("script");t.src="https://www.youtube.com/iframe_api",document.body.appendChild(t)}const t=window.onYouTubeIframeAPIReady;window.onYouTubeIframeAPIReady=()=>{t&&t(),createYouTubePlayers()}}}function formatTime(t){return`${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,"0")}`}async function fetchYouTubeTranscript(t){try{if("undefined"!=typeof window&&window.utils&&window.utils.getYouTubeTranscript){const e=await window.utils.getYouTubeTranscript(t);return e&&e.error?null:Array.isArray(e)?e:null}return null}catch(t){return null}}const transcriptLanguageOptions=[{code:"en",name:"English",nativeName:"English"},{code:"zh-CN",name:"Simplified Chinese",nativeName:"简体中文"},{code:"ja",name:"Japanese",nativeName:"日本語"},{code:"es",name:"Spanish",nativeName:"Español"}];async function translateAndRenderTranscript(t,e,n){const r=document.getElementById(t);if(!r)return;const a=transcriptData.get(e);if(!a||!Array.isArray(a)||0===a.length)return;if("undefined"==typeof window||!window.settings)return void console.error("Translation config not available");const s=window.settings.getAIChatApiEndpoint(),i=window.settings.getAIChatApiKey(),o=window.settings.getAIModel();if(!s||!i||!o)return void(window.utils&&window.utils.showMessageBox&&await window.utils.showMessageBox(i18n("transcript.translationConfigIncomplete","Translation Config Incomplete"),i18n("transcript.translationConfigIncompleteMessage","Please configure Chat API settings first."),i18n("transcript.openConfig","Open Config"),i18n("transcript.cancel","Cancel"),!1,"warning")&&window.utils&&window.utils.openAIConfig&&await window.utils.openAIConfig());transcriptTranslating.set(e,!0);const c=r.querySelector(".youtube-transcript-content");if(c){const t=document.createElement("div");t.className="youtube-transcript-loading",t.textContent=i18n("transcript.translating","Translating transcript..."),c.innerHTML="",c.appendChild(t)}try{const r=a.map((t=>t.text));if(!window.utils||!window.utils.translateTranscript)throw new Error("Translation API not available");const s=await window.utils.translateTranscript(r,n);transcriptTranslations.has(e)||transcriptTranslations.set(e,new Map),transcriptTranslations.get(e).set(n,s),renderTranscriptWithTranslation(t,e,n)}catch(t){console.error("Error translating transcript:",t);const e=t instanceof Error?t.message:String(t),n=r.querySelector(".youtube-transcript-content");if(n){const t=document.createElement("div");t.className="youtube-transcript-error";const r=i18n("transcript.translationFailed","Translation failed: {error}");t.textContent=r.replace("{error}",e),n.innerHTML="",n.appendChild(t)}window.utils&&window.utils.showErrorBox&&window.utils.showErrorBox("Translation Failed",e)}finally{transcriptTranslating.set(e,!1)}}function renderTranscriptWithTranslation(t,e,n){const r=document.getElementById(t);if(!r)return;const a=transcriptData.get(e);if(!a||!Array.isArray(a)||0===a.length)return;const s=r.querySelector(".youtube-transcript-content");if(!s)return;let i=null;if(n&&transcriptTranslations.has(e)){const t=transcriptTranslations.get(e);t.has(n)&&(i=t.get(n))}s.innerHTML="",a.forEach(((t,n)=>{const r=document.createElement("div");r.className="youtube-transcript-segment",r.setAttribute("data-start",t.start),r.setAttribute("data-video-id",e);const a=document.createElement("span");a.className="youtube-transcript-text";const o=document.createElement("div");if(o.className="youtube-transcript-original",o.textContent=t.text,a.appendChild(o),i&&i[n]){const t=document.createElement("div");t.className="youtube-transcript-translated",t.textContent=i[n],a.appendChild(t)}r.appendChild(a),s.appendChild(r)})),s.querySelectorAll(".youtube-transcript-segment").forEach((t=>{t.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation();const n=parseFloat(t.getAttribute("data-start")),r=t.getAttribute("data-video-id");if(!r||isNaN(n))return;let a=playerInstances.get(r);if(a||youtubePlayers.forEach(((t,e)=>{if(t===r&&!a){const t=document.getElementById(e);if(t){const e=t.querySelector("div");e&&e.player&&(a=e.player,playerInstances.set(r,a))}}})),a&&"function"==typeof a.seekTo)try{a.seekTo(n,!0),"function"==typeof a.playVideo&&a.playVideo()}catch(t){console.error("Error seeking to time:",n,t)}}))}));const o=t;userScrolling.set(o,!1),s.addEventListener("scroll",(()=>{userScrolling.set(o,!0),scrollResumeTimers.has(o)&&clearTimeout(scrollResumeTimers.get(o));const t=setTimeout((()=>{userScrolling.set(o,!1),scrollResumeTimers.delete(o)}),2e3);scrollResumeTimers.set(o,t)}))}function renderTranscriptLanguageMenu(t,e){const n=document.getElementById(t);if(!n)return null;const r=transcriptMenuOpen.get(e)||!1,a=document.querySelector(`.youtube-transcript-language-menu[data-video-id="${e}"]`);if(a&&a.remove(),!r)return null;const s=n.querySelector(`.youtube-transcript-language-chevron[data-video-id="${e}"]`);if(!s)return null;const i=s.getBoundingClientRect(),o=transcriptSelectedLanguages.get(e)||null,c=document.createElement("div");c.className="youtube-transcript-language-menu",c.setAttribute("data-video-id",e),Object.assign(c.style,{position:"fixed",zIndex:50,width:"260px",borderRadius:"16px",border:"1px solid rgba(0, 0, 0, 0.1)",backgroundColor:"#ffffff",padding:0,boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",top:`${i.bottom+4}px`,left:`${i.left}px`,outline:"none"});const u=document.createElement("div");u.style.cssText="max-height: 300px; overflow-y: auto;";const l=(t,e,n,r)=>{const a=document.createElement("div");Object.assign(a.style,{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"6px 8px",cursor:"pointer",fontSize:"12px",transition:"background-color 0.15s, color 0.15s",borderRadius:"4px",margin:"0 4px",userSelect:"none",outline:"none"}),a.onmouseenter=t=>t.currentTarget.style.backgroundColor="#f5f5f5",a.onmouseleave=t=>t.currentTarget.style.backgroundColor="transparent",a.onclick=r;const s=document.createElement("div"),i=document.createElement("div");if(Object.assign(i.style,{fontWeight:500,fontSize:"12px",color:"#000",lineHeight:"16px"}),i.textContent=t,s.appendChild(i),e){const t=document.createElement("div");Object.assign(t.style,{fontSize:"10px",color:"#666",lineHeight:"14px",marginTop:"2px"}),t.textContent=e,s.appendChild(t)}a.appendChild(s);const o=document.createElement("div");return o.style.cssText=`font-size: 16px; color: ${n?"#000":"#ccc"};`,o.innerHTML=n?"✓":'<svg width="16" height="16" viewBox="0 0 16 16"><circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1" fill="none"/></svg>',a.appendChild(o),a},p=l(i18n("transcript.showOriginal","Show original transcript"),null,!o,(()=>{transcriptSelectedLanguages.set(e,null),transcriptMenuOpen.set(e,!1),c.remove(),renderTranscriptWithTranslation(n.id,e,null)}));Object.assign(p.style,{borderBottom:"1px solid #f0f0f0",marginBottom:"4px",paddingBottom:"10px"}),u.appendChild(p),transcriptLanguageOptions.forEach((t=>{const r=t.code===o,a=l(t.nativeName,t.name,r,(()=>{const a=r?null:t.code;transcriptSelectedLanguages.set(e,a),transcriptMenuOpen.set(e,!1),c.remove(),a?translateAndRenderTranscript(n.id,e,a):renderTranscriptWithTranslation(n.id,e,null)}));u.appendChild(a)})),c.appendChild(u),document.body.appendChild(c);const d=()=>{transcriptMenuOpen.set(e,!1),c.remove(),document.removeEventListener("click",m)},m=t=>{c.contains(t.target)||s.contains(t.target)||d()};return c.onmouseleave=()=>setTimeout(d,100),setTimeout((()=>document.addEventListener("click",m)),0),c}function setupTranscriptLanguageMenu(t,e){const n=t.querySelector(`.youtube-transcript-language-chevron[data-video-id="${e}"]`);n&&(n.onclick=n=>{n.stopPropagation();const r=transcriptMenuOpen.get(e)||!1;transcriptMenuOpen.set(e,!r),renderTranscriptLanguageMenu(t.id,e)},renderTranscriptLanguageMenu(t.id,e))}function setupTabSwitching(t){const e=t.querySelectorAll(".youtube-transcript-tab"),n=t.querySelectorAll(".youtube-transcript-tab-content");e.forEach((r=>{r.addEventListener("click",(()=>{const a=r.getAttribute("data-tab");if(e.forEach((t=>t.classList.remove("active"))),r.classList.add("active"),n.forEach((t=>{t.getAttribute("data-content")===a?t.style.display="":t.style.display="none"})),"summary"===a){const e=t.id.match(/youtube-transcript-(\d+)/);if(e){const n=`youtube-player-${parseInt(e[1])}`,r=youtubePlayers.get(n);r&&setupSummaryTab(t,r)}}if("quotes"===a){const e=t.id.match(/youtube-transcript-(\d+)/);if(e){const n=`youtube-player-${parseInt(e[1])}`,r=youtubePlayers.get(n);r&&setupQuotesTab(t,r)}}if("chat"===a){const e=t.id.match(/youtube-transcript-(\d+)/);if(e){const n=`youtube-player-${parseInt(e[1])}`,r=youtubePlayers.get(n);r&&setupChatTab(t,r)}}}))}))}function markdownToHtml(t){if(!t||!t.trim())return"";let e=t;function n(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}const r=[];e=e.replace(/```([\s\S]*?)```/g,((t,e)=>{const a=`__CODE_BLOCK_${r.length}__`;return r.push(`<pre><code>${n(e.trim())}</code></pre>`),a}));const a=[];e=e.replace(/`([^`]+)`/g,((t,e)=>{const r=`__INLINE_CODE_${a.length}__`;return a.push(`<code>${n(e)}</code>`),r})),e=e.replace(/^### (.*$)/gim,"<h3>$1</h3>"),e=e.replace(/^## (.*$)/gim,"<h2>$1</h2>"),e=e.replace(/^# (.*$)/gim,"<h1>$1</h1>"),e=e.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),e=e.replace(/__(.+?)__/g,"<strong>$1</strong>"),e=e.replace(/\b\*([^*\s][^*]*?[^*\s])\*\b/g,"<em>$1</em>"),e=e.replace(/\b_([^_\s][^_]*?[^_\s])_\b/g,"<em>$1</em>"),e=e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');const s=e.split("\n"),i=[];let o=!1,c=[];for(let t=0;t<s.length;t++){const e=s[t].trim(),n=e.match(/^[\*\-] (.+)$/),r=e.match(/^\d+\. (.+)$/);if(n||r){o||(o=!0,c=[]);const t=n?n[1]:r[1];c.push(`<li>${t}</li>`)}else o&&(i.push(`<ul>${c.join("")}</ul>`),o=!1,c=[]),e?e.startsWith("<h")||e.startsWith("<pre")||e.startsWith("<ul")||e.startsWith("<ol")||e.startsWith("__CODE_BLOCK_")||e.startsWith("__INLINE_CODE_")?i.push(e):i.push(`<p>${e}</p>`):i.push("")}return o&&c.length>0&&i.push(`<ul>${c.join("")}</ul>`),e=i.join("\n"),r.forEach(((t,n)=>{e=e.replace(`__CODE_BLOCK_${n}__`,t)})),a.forEach(((t,n)=>{e=e.replace(`__INLINE_CODE_${n}__`,t)})),e}function escapeHtml(t){if("string"!=typeof t)return"";const e=document.createElement("div");return e.textContent=t,e.innerHTML}function parseTimestamp(t){const e=t.split(":").map((t=>parseInt(t,10)));return 2===e.length?60*e[0]+e[1]:3===e.length?3600*e[0]+60*e[1]+e[2]:null}function formatTimestamp(t){const e=Math.floor(t/3600),n=Math.floor(t%3600/60),r=Math.floor(t%60),a=t=>t.toString().padStart(2,"0");return e>0?`${a(e)}:${a(n)}:${a(r)}`:`${a(n)}:${a(r)}`}function getPlayerInstance(t){let e=playerInstances.get(t);return e||(youtubePlayers.forEach(((n,r)=>{if(n===t&&!e){const n=document.getElementById(r);if(n){const r=n.querySelector("div");r&&r.player&&(e=r.player,playerInstances.set(t,e))}}})),e)}function handleTimestampClick(t,e){const n=parseTimestamp(e);if(null===n)return void console.error("Invalid timestamp:",e);const r=getPlayerInstance(t);if(r&&"function"==typeof r.seekTo)try{r.seekTo(n,!0),"function"==typeof r.playVideo&&r.playVideo()}catch(t){console.error("Error seeking to time:",n,t)}else console.warn("Player instance not available for video:",t)}function getSummaryTitles(t){const e={overview:"Overview",takeaways:"Key Takeaways"},n={"zh-CN":{overview:"摘要速览",takeaways:"重点提要"},"zh-TW":{overview:"摘要速覽",takeaways:"重點提要"},ja:{overview:"概要",takeaways:"重要なポイント"},"fr-FR":{overview:"Aperçu",takeaways:"Points clés"},fr:{overview:"Aperçu",takeaways:"Points clés"},de:{overview:"Übersicht",takeaways:"Wichtige Punkte"},es:{overview:"Resumen",takeaways:"Puntos clave"},it:{overview:"Panoramica",takeaways:"Punti chiave"},"pt-BR":{overview:"Visão geral",takeaways:"Principais pontos"},"pt-PT":{overview:"Visão geral",takeaways:"Principais pontos"},pt:{overview:"Visão geral",takeaways:"Principais pontos"},ru:{overview:"Обзор",takeaways:"Ключевые моменты"},ko:{overview:"개요",takeaways:"핵심 요점"},nl:{overview:"Overzicht",takeaways:"Belangrijke punten"},sv:{overview:"Översikt",takeaways:"Viktiga punkter"},tr:{overview:"Genel Bakış",takeaways:"Önemli Noktalar"},uk:{overview:"Огляд",takeaways:"Ключові моменти"},cs:{overview:"Přehled",takeaways:"Klíčové body"},"fi-FI":{overview:"Yleiskatsaus",takeaways:"Tärkeät kohdat"},fi:{overview:"Yleiskatsaus",takeaways:"Tärkeät kohdat"}};if(!t)return e;if(n[t])return n[t];const r=t.split("-")[0];return n[r]?n[r]:e}function renderSummaryTakeaways(t,e){let n="",r=[];if(!t||"object"!=typeof t)return'<div class="youtube-transcript-summary-text">No summary available.</div>';if(Array.isArray(t))r=t;else{if(!t.overview||!t.takeaways)return'<div class="youtube-transcript-summary-text">No summary available.</div>';n=t.overview,r=Array.isArray(t.takeaways)?t.takeaways:[]}if(!r||0===r.length)return'<div class="youtube-transcript-summary-text">No takeaways available.</div>';const a=getSummaryTitles(get("l")||"en-US");let s='<div class="youtube-transcript-summary-text">';return n&&(s+='<div class="youtube-transcript-summary-overview">',s+=`<h3 class="youtube-transcript-summary-overview-title">${escapeHtml(a.overview)}</h3>`,s+=`<p class="youtube-transcript-summary-overview-content">${escapeHtml(n)}</p>`,s+="</div>"),s+='<div class="youtube-transcript-summary-takeaways">',s+=`<h3 class="youtube-transcript-summary-takeaways-title">${escapeHtml(a.takeaways)}</h3>`,s+='<div class="youtube-transcript-summary-takeaways-content">',r.forEach(((t,n)=>{s+='<div class="youtube-transcript-summary-takeaway-item">',s+=`<strong class="youtube-transcript-summary-label">${escapeHtml(t.label)}</strong>`,s+=`<span class="youtube-transcript-summary-insight">${escapeHtml(t.insight)}</span>`,t.timestamps&&Array.isArray(t.timestamps)&&t.timestamps.length>0&&(s+='<div class="youtube-transcript-summary-timestamps">',t.timestamps.forEach((t=>{t&&"string"==typeof t&&t.trim()&&(s+=`<button class="youtube-transcript-summary-timestamp" data-video-id="${e}" data-timestamp="${escapeHtml(t.trim())}" type="button">`,s+='<svg class="youtube-transcript-summary-timestamp-icon" width="12" height="12" viewBox="0 0 12 12" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 2.5L9.5 6L2.5 9.5V2.5Z" fill="currentColor"/></svg>',s+=`<span>${escapeHtml(t.trim())}</span>`,s+="</button>")})),s+="</div>"),s+="</div>"})),s+="</div>",s+="</div>",s+="</div>",s}function setupSummaryTimestampHandlers(t,e){t.querySelectorAll(".youtube-transcript-summary-timestamp").forEach((t=>{t.addEventListener("click",(n=>{n.preventDefault(),n.stopPropagation();const r=t.getAttribute("data-timestamp"),a=t.getAttribute("data-video-id");r&&a===e&&handleTimestampClick(e,r)}))}))}async function generateSummary(t){if(transcriptSummaries.has(t))return transcriptSummaries.get(t);const e=transcriptData.get(t);if(!e||!Array.isArray(e)||0===e.length)throw new Error("Transcript not available");if("undefined"==typeof window||!window.utils||!window.utils.generateTranscriptSummary)throw new Error("Utils bridge not available");const n=extractArticleSnippet();try{const r=await window.utils.generateTranscriptSummary(e,n);if(!(r&&r.overview&&r.takeaways&&Array.isArray(r.takeaways)&&0!==r.takeaways.length))throw new Error("Empty summary received from API");return transcriptSummaries.set(t,r),r}catch(t){throw t.message&&t.message.includes("配置不完整")&&window.utils&&window.utils.showMessageBox&&await window.utils.showMessageBox(i18n("transcript.translationConfigIncomplete","Translation Config Incomplete"),i18n("transcript.translationConfigIncompleteMessage","Please configure Chat API settings first."),i18n("transcript.openConfig","Open Config"),i18n("transcript.cancel","Cancel"),!1,"warning")&&window.utils.openAIConfig&&await window.utils.openAIConfig(),t}}function getInterpretationLabel(t){const e=i18n("transcript.interpretation",null);if(e&&"transcript.interpretation"!==e)return e;if(!t)return"Interpretation: ";const n={"zh-CN":"解读：","zh-TW":"解讀：",zh:"解读：",ja:"解釈：","fr-FR":"Interprétation : ",fr:"Interprétation : ",de:"Interpretation: ",es:"Interpretación: ",it:"Interpretazione: ","pt-BR":"Interpretação: ","pt-PT":"Interpretação: ",pt:"Interpretação: ",ru:"Интерпретация: ",ko:"해석: ",nl:"Interpretatie: ",sv:"Tolkning: ",tr:"Yorum: ",uk:"Інтерпретація: ",cs:"Interpretace: ","fi-FI":"Tulkinta: ",fi:"Tulkinta: "};if(n[t])return n[t];const r=t.split("-")[0];return n[r]?n[r]:"Interpretation: "}function renderQuotes(t,e){if(!t||!Array.isArray(t)||0===t.length)return'<div class="youtube-transcript-quotes-text">'+i18n("transcript.noQuotesAvailable","No quotes available.")+"</div>";const n=getInterpretationLabel(get("l")||"en-US");let r='<div class="youtube-transcript-quotes-text">';return r+='<ul class="youtube-transcript-quotes-list">',t.forEach(((t,a)=>{r+='<li class="youtube-transcript-quote-item">',t.speaker&&t.speaker.trim()&&(r+=`<div class="youtube-transcript-quote-speaker">${escapeHtml(t.speaker)}</div>`),r+=`<blockquote class="youtube-transcript-quote-text">"${escapeHtml(t.quote)}"</blockquote>`,t.interpretation&&t.interpretation.trim()&&(r+=`<div class="youtube-transcript-quote-interpretation"><span class="youtube-transcript-quote-interpretation-label">${escapeHtml(n)}</span>${escapeHtml(t.interpretation)}</div>`),t.timestamp&&(r+='<div class="youtube-transcript-quote-timestamp-wrapper">',r+=`<button class="youtube-transcript-quote-timestamp" data-video-id="${e}" data-timestamp="${t.timestamp}" type="button">`,r+='<svg class="youtube-transcript-quote-timestamp-icon" width="12" height="12" viewBox="0 0 12 12" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M2.5 2.5L9.5 6L2.5 9.5V2.5Z" fill="currentColor"/></svg>',r+=`<span>${escapeHtml(t.timestamp)}</span>`,r+="</button>",r+="</div>"),r+="</li>"})),r+="</ul>",r+="</div>",r}function setupQuotesTimestampHandlers(t,e){t.querySelectorAll(".youtube-transcript-quote-timestamp").forEach((t=>{t.addEventListener("click",(n=>{n.preventDefault(),n.stopPropagation();const r=t.getAttribute("data-timestamp"),a=t.getAttribute("data-video-id");r&&a===e&&handleTimestampClick(e,r)}))}))}function extractArticleSnippet(){try{const t=get("a");if(t){const e=decodeURIComponent(t),n=document.createElement("div");return n.innerHTML=e,(n.textContent||n.innerText||"").trim().substring(0,500)}const e=document.getElementById("main");if(e){const t=e.querySelector("article");if(t)return(t.textContent||t.innerText||"").trim().substring(0,500)}}catch(t){console.warn("Failed to extract article snippet:",t)}}async function generateQuotes(t){if(transcriptQuotes.has(t))return transcriptQuotes.get(t);const e=transcriptData.get(t);if(!e||!Array.isArray(e)||0===e.length)throw new Error("Transcript not available");if("undefined"==typeof window||!window.utils||!window.utils.generateJuiciestQuotes)throw new Error("Utils bridge not available");const n=extractArticleSnippet();try{const r=await window.utils.generateJuiciestQuotes(e,n);if(!r||!Array.isArray(r)||0===r.length)throw new Error("Empty quotes received from API");return transcriptQuotes.set(t,r),r}catch(t){throw t.message&&t.message.includes("配置不完整")&&window.utils&&window.utils.showMessageBox&&await window.utils.showMessageBox(i18n("transcript.translationConfigIncomplete","Translation Config Incomplete"),i18n("transcript.translationConfigIncompleteMessage","Please configure Chat API settings first."),i18n("transcript.openConfig","Open Config"),i18n("transcript.cancel","Cancel"),!1,"warning")&&window.utils.openAIConfig&&await window.utils.openAIConfig(),t}}async function setupQuotesTab(t,e){const n=t.querySelector(".youtube-transcript-quotes-content");if(!n)return;if("undefined"==typeof window||!window.settings){const t=i18n("transcript.chat.configIncomplete","AI Model Not Configured");return void(n.innerHTML='<div class="youtube-transcript-quotes-error">'+t+"</div>")}const r=window.settings.getAIChatApiEndpoint(),a=window.settings.getAIChatApiKey(),s=window.settings.getAIModel();if(!r||!a||!s){const t=i18n("transcript.chat.configIncomplete","AI Model Not Configured"),e=i18n("transcript.chat.configIncompleteMessage","Please configure Chat API settings first."),r=i18n("transcript.openConfig","Open Config");n.innerHTML=`\n            <div class="youtube-transcript-quotes-config-incomplete">\n                <div class="youtube-transcript-quotes-config-message">\n                    <div class="youtube-transcript-quotes-config-title">${t}</div>\n                    <div class="youtube-transcript-quotes-config-desc">${e}</div>\n                </div>\n                <button type="button" class="youtube-transcript-quotes-config-button">${r}</button>\n            </div>\n        `;const a=n.querySelector(".youtube-transcript-quotes-config-button");return void(a&&window.utils&&window.utils.openAIConfig&&a.addEventListener("click",(async t=>{t.preventDefault(),t.stopPropagation(),await window.utils.openAIConfig()})))}const i=transcriptQuotes.get(e);if(i){const t=renderQuotes(i,e);n.innerHTML=t,setupQuotesTimestampHandlers(n,e)}else{n.innerHTML=`\n            <div class="youtube-transcript-quotes-empty">\n                <button class="youtube-transcript-quotes-generate">${i18n("transcript.extractQuotes","Extract Quotes")}</button>\n            </div>\n        `;const r=n.querySelector(".youtube-transcript-quotes-generate");r&&r.addEventListener("click",(async()=>{r.disabled=!0,r.textContent=i18n("transcript.extracting","Extracting..."),n.innerHTML='<div class="youtube-transcript-quotes-loading">'+i18n("transcript.extractingQuotes","Extracting quotes...")+"</div>";try{const t=renderQuotes(await generateQuotes(e),e);n.innerHTML=t,setupQuotesTimestampHandlers(n,e)}catch(r){console.error("Error extracting quotes:",r);const a=r instanceof Error?r.message:String(r),s=i18n("transcript.failedToExtractQuotes","Failed to extract quotes: {error}");n.innerHTML=`\n                        <div class="youtube-transcript-quotes-error">\n                            <div>${s.replace("{error}",a)}</div>\n                            <button class="youtube-transcript-quotes-retry">${i18n("transcript.retry","Retry")}</button>\n                        </div>\n                    `;const i=n.querySelector(".youtube-transcript-quotes-retry");i&&i.addEventListener("click",(()=>{setupQuotesTab(t,e)}))}}))}}async function setupSummaryTab(t,e){const n=t.querySelector(".youtube-transcript-summary-content");if(!n)return;if("undefined"==typeof window||!window.settings){const t=i18n("transcript.chat.configIncomplete","AI Model Not Configured");return void(n.innerHTML='<div class="youtube-transcript-summary-error">'+t+"</div>")}const r=window.settings.getAIChatApiEndpoint(),a=window.settings.getAIChatApiKey(),s=window.settings.getAIModel();if(!r||!a||!s){const t=i18n("transcript.chat.configIncomplete","AI Model Not Configured"),e=i18n("transcript.chat.configIncompleteMessage","Please configure Chat API settings first."),r=i18n("transcript.openConfig","Open Config");n.innerHTML=`\n            <div class="youtube-transcript-summary-config-incomplete">\n                <div class="youtube-transcript-summary-config-message">\n                    <div class="youtube-transcript-summary-config-title">${t}</div>\n                    <div class="youtube-transcript-summary-config-desc">${e}</div>\n                </div>\n                <button type="button" class="youtube-transcript-summary-config-button">${r}</button>\n            </div>\n        `;const a=n.querySelector(".youtube-transcript-summary-config-button");return void(a&&window.utils&&window.utils.openAIConfig&&a.addEventListener("click",(async t=>{t.preventDefault(),t.stopPropagation(),await window.utils.openAIConfig()})))}const i=transcriptSummaries.get(e);if(i){const t=renderSummaryTakeaways(i,e);n.innerHTML=t,setupSummaryTimestampHandlers(n,e)}else{n.innerHTML=`\n            <div class="youtube-transcript-summary-empty">\n                <button class="youtube-transcript-summary-generate">${i18n("transcript.generateSummary","Generate Summary")}</button>\n            </div>\n        `;const r=n.querySelector(".youtube-transcript-summary-generate");r&&r.addEventListener("click",(async()=>{r.disabled=!0,r.textContent=i18n("transcript.generating","Generating..."),n.innerHTML='<div class="youtube-transcript-summary-loading">'+i18n("transcript.generatingSummary","Generating summary...")+"</div>";try{const t=renderSummaryTakeaways(await generateSummary(e),e);n.innerHTML=t,setupSummaryTimestampHandlers(n,e)}catch(r){console.error("Error generating summary:",r);const a=r instanceof Error?r.message:String(r),s=i18n("transcript.failedToGenerateSummary","Failed to generate summary: {error}");n.innerHTML=`\n                        <div class="youtube-transcript-summary-error">\n                            <div>${s.replace("{error}",a)}</div>\n                            <button class="youtube-transcript-summary-retry">${i18n("transcript.retry","Retry")}</button>\n                        </div>\n                    `;const i=n.querySelector(".youtube-transcript-summary-retry");i&&i.addEventListener("click",(()=>{setupSummaryTab(t,e)}))}}))}}function parseTimestampToSeconds(t){const e=t.split(":").map((t=>parseInt(t,10)));return 2===e.length?60*e[0]+e[1]:3===e.length?3600*e[0]+60*e[1]+e[2]:null}function formatTimestampFromSeconds(t){const e=Math.floor(t/3600),n=Math.floor(t%3600/60),r=Math.floor(t%60);return e>0?`${e.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`:`${n.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`}function renderTimestampButtons(t,e,n){if(!e||0===e.length)return t;const r=/\[(\d{1,2}:\d{2}(?::\d{2})?)\]/g;let a=t;const s=[];let i;for(;null!==(i=r.exec(t));)s.push({index:i.index,length:i[0].length,timestamp:i[1],fullMatch:i[0]});for(let t=s.length-1;t>=0;t--){const e=s[t],r=parseTimestampToSeconds(e.timestamp);if(null!==r){const t=`<button class="youtube-transcript-chat-timestamp" data-timestamp="${e.timestamp}" data-seconds="${r}" data-video-id="${n}">\n                <svg class="youtube-transcript-chat-timestamp-icon" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">\n                    <path d="M3 2.5L9 6L3 9.5V2.5Z" fill="currentColor"/>\n                </svg>\n                <span>${e.timestamp}</span>\n            </button>`;a=a.substring(0,e.index)+t+a.substring(e.index+e.length)}}return a}async function setupChatTab(t,e){const n=t.querySelector(".youtube-transcript-chat");if(!n)return;if(n.querySelector(".youtube-transcript-chat-content"))return;if("undefined"==typeof window||!window.settings)return void(n.innerHTML='<div class="youtube-transcript-chat-error">'+i18n("transcript.chat.configIncomplete","AI Model Not Configured")+"</div>");const r=window.settings.getAIChatApiEndpoint(),a=window.settings.getAIChatApiKey(),s=window.settings.getAIModel();if(!r||!a||!s){const t=i18n("transcript.chat.configIncomplete","AI Model Not Configured"),e=i18n("transcript.chat.configIncompleteMessage","Please configure Chat API settings first."),r=i18n("transcript.openConfig","Open Config");i18n("transcript.cancel","Cancel"),n.innerHTML=`\n            <div class="youtube-transcript-chat-content">\n                <div class="youtube-transcript-chat-config-incomplete">\n                    <div class="youtube-transcript-chat-config-message">\n                        <div class="youtube-transcript-chat-config-title">${t}</div>\n                        <div class="youtube-transcript-chat-config-desc">${e}</div>\n                    </div>\n                    <button type="button" class="youtube-transcript-chat-config-button">${r}</button>\n                </div>\n            </div>\n        `;const a=n.querySelector(".youtube-transcript-chat-config-button");return void(a&&window.utils&&window.utils.openAIConfig&&a.addEventListener("click",(async t=>{t.preventDefault(),t.stopPropagation(),await window.utils.openAIConfig()})))}const i=transcriptData.get(e);if(!i||!Array.isArray(i)||0===i.length){const t=i18n("transcript.chat.transcriptNotAvailable","Transcript not available");return void(n.innerHTML='<div class="youtube-transcript-chat-error">'+t+"</div>")}transcriptChatMessages.has(e)||transcriptChatMessages.set(e,[]);const o=transcriptChatMessages.get(e),c=i18n("transcript.chat.placeholder","Ask about the video..."),u=(i18n("transcript.chat.send","Send"),i18n("transcript.chat.loading","Thinking..."));n.innerHTML=`\n        <div class="youtube-transcript-chat-content">\n            <div class="youtube-transcript-chat-messages"></div>\n            <form class="youtube-transcript-chat-input-container" onsubmit="return false;" autocomplete="off" novalidate>\n                <div class="youtube-transcript-chat-input-wrapper">\n                    <textarea class="youtube-transcript-chat-input" placeholder="${c}" rows="2" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off"></textarea>\n                    <button type="button" class="youtube-transcript-chat-send">\n                        <svg width="12" height="12" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">\n                            <path d="M13.5 0.5L6.5 7.5M13.5 0.5L9.5 13.5L6.5 7.5M13.5 0.5L0.5 4.5L6.5 7.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>\n                        </svg>\n                    </button>\n                </div>\n            </form>\n        </div>\n    `;const l=n.querySelector(".youtube-transcript-chat-messages"),p=n.querySelector(".youtube-transcript-chat-input"),d=n.querySelector(".youtube-transcript-chat-send"),m=n.querySelector(".youtube-transcript-chat-input-container"),y=n.querySelector(".youtube-transcript-chat-input-wrapper");if(m){const t=t=>(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1);m.addEventListener("submit",t,!0),m.addEventListener("reset",t,!0),m.setAttribute("onsubmit","return false;"),m.setAttribute("onreset","return false;"),m.addEventListener("formdata",(t=>{t.preventDefault(),t.stopPropagation()}),!0)}if(y&&(y.addEventListener("click",(t=>{t.stopPropagation()})),y.addEventListener("mousedown",(t=>{t.stopPropagation()})),y.addEventListener("mouseup",(t=>{t.stopPropagation()}))),n){const t=t=>{if(t.target&&n.contains(t.target)){if(t.target.closest(".youtube-transcript-chat-send"))return;("submit"===t.type||"reset"===t.type||"keydown"===t.type&&"Enter"===t.key&&!t.shiftKey)&&(t.stopPropagation(),t.stopImmediatePropagation())}};n.addEventListener("submit",t,!0),n.addEventListener("reset",t,!0)}const g=t=>{t.target&&t.target.hasAttribute&&t.target.hasAttribute("data-chat-input")&&"submit"===t.type&&(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation())};function v(){l&&(l.innerHTML="",o.forEach(((t,n)=>{const r=document.createElement("div");if(r.className=`youtube-transcript-chat-message youtube-transcript-chat-message-${t.role}`,"user"===t.role)r.innerHTML=`<div class="youtube-transcript-chat-message-content">${escapeHtml(t.content)}</div>`;else{const n=renderTimestampButtons(t.content,t.timestamps||[],e);r.innerHTML=`<div class="youtube-transcript-chat-message-content">${n}</div>`}l.appendChild(r)})),l.querySelectorAll(".youtube-transcript-chat-timestamp").forEach((t=>{t.addEventListener("click",(n=>{n.preventDefault(),n.stopPropagation();const r=t.getAttribute("data-timestamp"),a=t.getAttribute("data-video-id");r&&a===e&&handleTimestampClick(e,r)}))})),l.scrollTop=l.scrollHeight)}async function f(){if(!p||!d)return;const t=p.value.trim();if(!t)return;const e=window.settings.getAIChatApiEndpoint(),n=window.settings.getAIChatApiKey(),r=window.settings.getAIModel();if(!e||!n||!r)return void(window.utils&&window.utils.showMessageBox&&await window.utils.showMessageBox(i18n("transcript.chat.configIncomplete","AI Model Not Configured"),i18n("transcript.chat.configIncompleteMessage","Please configure Chat API settings first."),i18n("transcript.openConfig","Open Config"),i18n("transcript.cancel","Cancel"),!1,"warning")&&window.utils.openAIConfig&&await window.utils.openAIConfig());o.push({role:"user",content:t}),p.value="",p.disabled=!0,d.disabled=!0,v();const a=document.createElement("div");a.className="youtube-transcript-chat-message youtube-transcript-chat-message-assistant youtube-transcript-chat-message-loading",a.innerHTML=`<div class="youtube-transcript-chat-message-content">${u}</div>`,l&&(l.appendChild(a),l.scrollTop=l.scrollHeight);try{const e=o.slice(-10).map((t=>({role:t.role,content:t.content})));if(!window.utils||!window.utils.chatWithTranscript){const t=i18n("transcript.chat.apiNotAvailable","Chat API not available");throw new Error(t)}const n=await window.utils.chatWithTranscript(t,i,e),r=l.querySelector(".youtube-transcript-chat-message-loading");r&&r.remove(),o.push({role:"assistant",content:n.content,timestamps:n.timestamps||[]}),v()}catch(t){console.error("Error sending chat message:",t);const e=l.querySelector(".youtube-transcript-chat-message-loading");e&&e.remove();const n=t instanceof Error?t.message:String(t),r=i18n("transcript.chat.error","Failed to get response");o.push({role:"assistant",content:`${r}: ${n}`,timestamps:[]}),v()}finally{p.disabled=!1,d.disabled=!1,p.focus()}}document.addEventListener("submit",g,!0),n._globalEventBlocker=g,d&&d.addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation(),f()}));let b=!1;p&&(p.addEventListener("compositionstart",(t=>{b=!0,p.setAttribute("data-composing","true"),t.stopPropagation(),t.stopImmediatePropagation()}),!0),p.addEventListener("compositionupdate",(t=>{t.stopPropagation(),t.stopImmediatePropagation()}),!0),p.addEventListener("compositionend",(t=>{b=!1,p.removeAttribute("data-composing"),t.stopPropagation(),t.stopImmediatePropagation()}),!0),p.addEventListener("keydown",(t=>{if(!b||"Enter"!==t.key)return"Enter"!==t.key||t.shiftKey?void(("Escape"===t.key||t.ctrlKey&&"Enter"===t.key)&&t.stopPropagation()):(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),setTimeout((()=>{f()}),0),!1)}),!1),p.addEventListener("keypress",(t=>{if("Enter"===t.key&&!t.shiftKey&&!b)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1}),!1),p.addEventListener("input",(t=>{t.stopPropagation()})),p.addEventListener("beforeinput",(t=>{t.stopPropagation()})),p.addEventListener("focus",(t=>{t.stopPropagation(),t.stopImmediatePropagation()}),!0),p.addEventListener("blur",(t=>{t.stopPropagation(),t.stopImmediatePropagation()}),!0),p.addEventListener("paste",(t=>{t.stopPropagation(),t.stopImmediatePropagation()}),!0),p.addEventListener("cut",(t=>{t.stopPropagation(),t.stopImmediatePropagation()}),!0),p.addEventListener("copy",(t=>{t.stopPropagation(),t.stopImmediatePropagation()}),!0),p.addEventListener("contextmenu",(t=>{t.stopPropagation(),t.stopImmediatePropagation()}),!0),p.addEventListener("selectstart",(t=>{t.stopPropagation()}),!0),p.setAttribute("data-chat-input","true"),p.addEventListener("invalid",(t=>{t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation()}),!0)),v()}function escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}function updateTranscriptSegment(t,e){let n=null;if(youtubePlayers.forEach(((e,r)=>{if(e===t){const t=`youtube-transcript-${r.replace("youtube-player-","")}`;n=document.getElementById(t)}})),!n)return;const r=n.querySelector(".youtube-transcript-content");if(!r)return;const a=r.querySelectorAll(".youtube-transcript-segment");if(0===a.length)return;let s=null;for(let t=0;t<a.length;t++){const n=a[t],r=parseFloat(n.getAttribute("data-start")),i=a[t+1],o=i?parseFloat(i.getAttribute("data-start")):1/0;if(e>=r&&e<o){s=n;break}}if(!s&&a.length>0){const t=a[a.length-1];e>=parseFloat(t.getAttribute("data-start"))&&(s=t)}const i=n.querySelector(".youtube-transcript-segment.current");if(a.forEach((t=>t.classList.remove("current"))),s){const t=i!==s;s.classList.add("current"),s.offsetHeight;const e=n.id;if(userScrolling.get(e))return;s.offsetHeight;const a=r.scrollTop;let o=0,c=s;for(;c&&c!==r;)o+=c.offsetTop,c=c.offsetParent;if(0===o||c!==r){const t=s.getBoundingClientRect(),e=r.getBoundingClientRect();o=t.top-e.top+a}const u=o-12,l=.1;if(Math.abs(a-u)>l||t){const n=lastScrollTarget.get(e);(void 0===n||Math.abs(n-u)>10||t)&&void 0!==n&&(r.scrollTop=a),lastScrollTarget.set(e,u),r.scrollTo({top:Math.max(0,u),behavior:"smooth"})}else lastScrollTarget.set(e,u)}}function startTranscriptTracking(t){transcriptIntervals.has(t)&&clearInterval(transcriptIntervals.get(t));const e=setInterval((()=>{try{let e=null,n=null;if(youtubePlayers.forEach(((r,a)=>{if(r===t){const r=document.getElementById(a);if(r&&(n=r.querySelector("div"),n)){if(n.player&&(e=n.player),!e&&window.youtubePlayerInstances&&(n.id&&(e=window.youtubePlayerInstances.get(n.id)||null),e||(e=window.youtubePlayerInstances.get(t)||null)),!e&&n.id&&window.YT&&window.YT.get)try{e=window.YT.get(n.id)}catch(t){}if(!e){const t=n.querySelector("iframe");if(t&&t.id&&window.YT&&window.YT.get)try{e=window.YT.get(t.id)}catch(t){}}if(!e&&window.YT&&window.YT.get)try{const r=[n.id,`${n.id}-player`,`youtube-player-${t}`,t];for(const t of r)try{const n=window.YT.get(t);if(n&&"function"==typeof n.getCurrentTime){e=n;break}}catch(t){}}catch(t){}}}})),e&&"function"==typeof e.getCurrentTime)try{const n=e.getCurrentTime();"number"==typeof n&&n>=0&&!isNaN(n)&&updateTranscriptSegment(t,n)}catch(t){}}catch(n){console.error("[Transcript] Error in tracking:",n),clearInterval(e),transcriptIntervals.delete(t)}}),100);transcriptIntervals.set(t,e)}function stopTranscriptTracking(t){transcriptIntervals.has(t)&&(clearInterval(transcriptIntervals.get(t)),transcriptIntervals.delete(t))}async function renderTranscript(t,e){const n=document.getElementById(t);if(!n)return;const r=i18n("transcript.tab.transcript","Transcript"),a=i18n("transcript.tab.aiSummary","AI Summary"),s=i18n("transcript.tab.quotes","Quotes"),i=i18n("transcript.tab.chat","Chat"),o=i18n("transcript.loading","Loading transcript..."),c=i18n("transcript.notAvailable","Transcript not available for this video."),u=i18n("transcript.reload","Reload");n.innerHTML='<div class="youtube-transcript"><div class="youtube-transcript-tabs"><button class="youtube-transcript-tab active" data-tab="transcript"><span>'+r+'</span><span class="youtube-transcript-language-chevron" data-video-id="'+e+'"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span></button><button class="youtube-transcript-tab" data-tab="summary">'+a+'</button><button class="youtube-transcript-tab" data-tab="quotes">'+s+'</button><button class="youtube-transcript-tab" data-tab="chat">'+i+'</button></div><div class="youtube-transcript-tab-content" data-content="transcript"><div class="youtube-transcript-content"><div class="youtube-transcript-loading">'+o+'</div></div></div><div class="youtube-transcript-tab-content" data-content="summary" style="display: none;"><div class="youtube-transcript-summary"><div class="youtube-transcript-summary-content"></div></div></div><div class="youtube-transcript-tab-content" data-content="quotes" style="display: none;"><div class="youtube-transcript-quotes"><div class="youtube-transcript-quotes-content"></div></div></div><div class="youtube-transcript-tab-content" data-content="chat" style="display: none;"><div class="youtube-transcript-chat"></div></div></div>';const l=await fetchYouTubeTranscript(e);if(!l||!Array.isArray(l)||0===l.length){n.innerHTML='<div class="youtube-transcript"><div class="youtube-transcript-tabs"><button class="youtube-transcript-tab active" data-tab="transcript"><span>'+r+'</span><span class="youtube-transcript-language-chevron" data-video-id="'+e+'"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span></button><button class="youtube-transcript-tab" data-tab="summary">'+a+'</button><button class="youtube-transcript-tab" data-tab="quotes">'+s+'</button><button class="youtube-transcript-tab" data-tab="chat">'+i+'</button></div><div class="youtube-transcript-tab-content" data-content="transcript"><div class="youtube-transcript-content"><div class="youtube-transcript-error"><div>'+c+'</div><button class="youtube-transcript-reload">'+u+'</button></div></div></div><div class="youtube-transcript-tab-content" data-content="summary" style="display: none;"><div class="youtube-transcript-summary"><div class="youtube-transcript-summary-content"></div></div></div><div class="youtube-transcript-tab-content" data-content="quotes" style="display: none;"><div class="youtube-transcript-quotes"><div class="youtube-transcript-quotes-content"></div></div></div><div class="youtube-transcript-tab-content" data-content="chat" style="display: none;"><div class="youtube-transcript-chat"></div></div></div>',setupTabSwitching(n),setupTranscriptLanguageMenu(n,e);const o=n.querySelector(".youtube-transcript-content");if(o){const n=o.querySelector(".youtube-transcript-reload");n&&n.addEventListener("click",(()=>{renderTranscript(t,e)}))}return}transcriptData.set(e,l);let p='<div class="youtube-transcript">';p+='<div class="youtube-transcript-tabs">',p+='<button class="youtube-transcript-tab active" data-tab="transcript"><span>'+r+'</span><span class="youtube-transcript-language-chevron" data-video-id="'+e+'"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span></button>',p+='<button class="youtube-transcript-tab" data-tab="summary">'+a+"</button>",p+='<button class="youtube-transcript-tab" data-tab="quotes">'+s+"</button>",p+='<button class="youtube-transcript-tab" data-tab="chat">'+i+"</button>",p+="</div>",p+='<div class="youtube-transcript-tab-content" data-content="transcript">',p+='<div class="youtube-transcript-content"></div>',p+="</div>",p+='<div class="youtube-transcript-tab-content" data-content="summary" style="display: none;">',p+='<div class="youtube-transcript-summary">',p+='<div class="youtube-transcript-summary-content"></div>',p+="</div>",p+="</div>",p+='<div class="youtube-transcript-tab-content" data-content="quotes" style="display: none;">',p+='<div class="youtube-transcript-quotes">',p+='<div class="youtube-transcript-quotes-content"></div>',p+="</div>",p+="</div>",p+='<div class="youtube-transcript-tab-content" data-content="chat" style="display: none;">',p+='<div class="youtube-transcript-chat"></div>',p+="</div>",p+="</div>",n.innerHTML=p,setupTabSwitching(n),setupTranscriptLanguageMenu(n,e);const d=transcriptSelectedLanguages.get(e)||null;renderTranscriptWithTranslation(t,e,d)}function createYouTubePlayers(){const t=get("u")||"";let e="";try{if(t&&(t.startsWith("http://")||t.startsWith("https://"))){const n=new URL(t);e=n.origin}}catch(n){const r=t.match(/^(https?:\/\/[^\/]+)/);r&&(e=r[1])}youtubePlayers.forEach(((t,n)=>{const r=document.getElementById(n);if(!r)return;const a=r.querySelector("div");if(!a)return;const s=`${n}-inner`;a.id=s;try{const n={videoId:t,playerVars:{autoplay:0,controls:1,modestbranding:1,rel:0},events:{onReady:n=>{const r=a.querySelector("iframe");if(r&&(r.setAttribute("referrerpolicy","strict-origin-when-cross-origin"),e))try{const t=r.src,n=new URL(t);n.searchParams.set("origin",e),r.src=n.toString()}catch(t){console.error("Error modifying iframe src:",t)}const s=n.target;a.player=s,playerInstances.set(t,s)},onStateChange:e=>{const n=1===e.data,r=a.player;if(n&&r){transcriptIntervals.has(t)&&clearInterval(transcriptIntervals.get(t));const e=setInterval((()=>{try{if(r&&"function"==typeof r.getCurrentTime){const e=r.getCurrentTime();"number"==typeof e&&e>=0&&!isNaN(e)&&updateTranscriptSegment(t,e)}}catch(n){clearInterval(e),transcriptIntervals.delete(t)}}),100);transcriptIntervals.set(t,e)}}}};e&&(n.origin=e),new window.YT.Player(a,n)}catch(t){console.error("Error creating YouTube player:",t)}}))}async function getArticle(t){let e=get("a");return"1"===get("m")?(await Mercury.parse(t,{html:e})).content||"":e}document.documentElement.style.fontSize=get("s")+"px";let font=get("f");font&&(document.body.style.fontFamily=`"${font}"`);let url=get("u");if(url)getArticle(url).then((t=>{youtubePlayerCounter=0,youtubePlayers.clear(),t&&(t=convertYouTubeLinks(t));const e=get("h");if(!e){console.error('Article HTML parameter "h" is missing');const t=document.getElementById("main");return void(t&&(t.innerHTML='<div style="padding: 20px; text-align: center;">Error: Article HTML is missing</div>',t.classList.add("show")))}let n=(new DOMParser).parseFromString(e,"text/html");const r=n.getElementsByTagName("article")[0];if(!r){console.error("Article element not found in HTML");const t=document.getElementById("main");return void(t&&(t.innerHTML='<div style="padding: 20px; text-align: center;">Error: Article structure is invalid</div>',t.classList.add("show")))}r.innerHTML=t;let a=n.createElement("base");a.setAttribute("href",url.split("/").slice(0,3).join("/")),n.head.append(a);for(let t of n.getElementsByTagName("script"))t.parentNode.removeChild(t);for(let t of n.querySelectorAll("*[src]"))t.src=t.src;for(let t of n.querySelectorAll("*[href]"))t.href=t.href;let s=document.getElementById("main");s?(s.innerHTML=n.body.innerHTML,s.classList.add("show"),setTimeout((()=>{startLoadingTranscripts(),initializeYouTubePlayers()}),0)):console.error("Main element not found")})).catch((t=>{console.error("Error loading article:",t);const e=document.getElementById("main");e&&(e.innerHTML='<div style="padding: 20px; text-align: center;">Error loading article: '+String(t)+"</div>",e.classList.add("show"))}));else{console.error('Article URL parameter "u" is missing');const t=document.getElementById("main");t&&(t.innerHTML='<div style="padding: 20px; text-align: center;">Error: Article URL is missing</div>',t.classList.add("show"))}window.addEventListener("beforeunload",(()=>{transcriptIntervals.forEach((t=>{clearInterval(t)})),transcriptIntervals.clear(),scrollResumeTimers.forEach((t=>{clearTimeout(t)})),scrollResumeTimers.clear(),userScrolling.clear(),playerInstances.clear()}));